# 服务器配置变更指南

## 📋 概述

本文档提供服务器端配置变更的标准流程，确保变更安全、可控、可回滚。

---

## 🎯 配置变更类型

### 1. 提示词配置变更（最常见）
- **影响范围**：评语生成质量
- **是否需要重启**：否（推荐使用热重载）
- **回滚难度**：低

### 2. 环境变量变更
- **影响范围**：数据库连接、API密钥等
- **是否需要重启**：是
- **回滚难度**：中

### 3. 代码变更
- **影响范围**：系统功能
- **是否需要重启**：是
- **回滚难度**：高

---

## 🔧 提示词配置变更流程（重点）

### 方式一：使用数据库导入脚本（推荐）

#### 步骤 1：准备配置文件

在本地编辑并验证 `public/prompts.json`：

```bash
# 验证 JSON 格式
python3 -c "import json; json.load(open('public/prompts.json'))"

# 如果没有报错，继续下一步
```

#### 步骤 2：上传文件到服务器

```bash
# 方式 A：使用 SCP
scp public/prompts.json root@8.134.89.239:"/root/Intelligent Comment System/public/"

# 方式 B：使用 expect 脚本（自动化）
./scripts/upload_prompts.sh
```

#### 步骤 3：创建数据导入脚本

服务器上已有 `import_prompts.js` 脚本，如果需要更新：

```javascript
// import_prompts.js
const Database = require('better-sqlite3');
const fs = require('fs');
const path = require('path');

const promptsPath = path.join(__dirname, 'public', 'prompts.json');
const prompts = JSON.parse(fs.readFileSync(promptsPath, 'utf8'));
const db = new Database(path.join(__dirname, 'comments.db'));

console.log('开始导入 prompts.json 到数据库...\n');

['kindergarten', 'primary', 'middle'].forEach(segment => {
  // 导入基础模板
  const baseKey = `base_${segment}`;
  const baseValue = prompts[segment][0].template;

  db.prepare(`
    INSERT INTO system_configs (config_key, config_value)
    VALUES (?, ?)
    ON CONFLICT(config_key) DO UPDATE SET config_value = excluded.config_value
  `).run(baseKey, baseValue);

  console.log(`✓ 导入基础模板: ${baseKey}`);

  // 导入每个风格
  prompts[segment].forEach(style => {
    const styleKey = `style_${segment}_${style.style}`;
    db.prepare(`
      INSERT INTO system_configs (config_key, config_value)
      VALUES (?, ?)
      ON CONFLICT(config_key) DO UPDATE SET config_value = excluded.config_value
    `).run(styleKey, style.template);

    console.log(`✓ 导入风格模板: ${styleKey} (${style.name})`);
  });
});

console.log('\n导入完成！');
db.close();
```

#### 步骤 4：执行导入（SSH 到服务器）

```bash
# SSH 登录服务器
ssh root@8.134.89.239

# 进入项目目录
cd '/root/Intelligent Comment System'

# 执行导入脚本
node import_prompts.js

# 预期输出
# ✓ 导入基础模板: base_kindergarten
# ✓ 导入风格模板: style_kindergarten_lively-horse (活泼小马)
# ...
# 导入完成！
```

#### 步骤 5：验证配置（无需重启服务）

```bash
# 查询数据库验证
sqlite3 comments.db "SELECT config_key FROM system_configs WHERE config_key LIKE 'style_%';"

# 测试 API
curl -X POST http://localhost:3001/api/generate \
  -H "Content-Type: application/json" \
  -d '{
    "code": "test123",
    "name": "测试学生",
    "gender": "男",
    "tags": "活泼,好学",
    "wordLimit": 150,
    "segment": "kindergarten",
    "style_key": "lively-horse"
  }'
```

#### 步骤 6：重启服务（如果需要）

```bash
# 仅在导入后 API 测试失败时执行
systemctl restart comment-api

# 检查服务状态
systemctl status comment-api

# 查看日志
journalctl -u comment-api -n 20 --no-pager
```

---

### 方式二：热重载（无需重启，推荐用于频繁更新）

#### 前置条件

在 `server.js` 中添加热重载端点（需要一次性代码更新）：

```javascript
// 提供热重载 API（需要管理员密钥）
app.post('/internal/reload-prompts', (req, res) => {
  const { adminKey } = req.body;

  if (adminKey !== process.env.ADMIN_SECRET_KEY) {
    return res.status(403).json({ error: 'Unauthorized' });
  }

  try {
    // 重新从数据库加载所有 prompts 到内存
    reloadPromptsCache();
    res.json({ success: true, message: 'Prompts reloaded successfully' });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});
```

#### 使用热重载

```bash
# 1. 上传并导入新配置到数据库（同上）

# 2. 调用热重载 API
curl -X POST http://8.134.89.239:3001/internal/reload-prompts \
  -H "Content-Type: application/json" \
  -d '{"adminKey": "your-admin-secret-key"}'

# 响应示例
# {"success": true, "message": "Prompts reloaded successfully"}
```

---

## 🔄 配置回滚流程

### 紧急回滚

如果新配置导致问题，立即回滚：

```bash
# 1. SSH 到服务器
ssh root@8.134.89.239

# 2. 恢复备份的数据库
cp comments.db.backup-20260121 comments.db

# 3. 重启服务
systemctl restart comment-api

# 4. 验证服务正常
curl http://8.134.89.239:3001/
```

### 数据库备份策略

#### 配置变更前自动备份

```bash
# 在 import_prompts.js 脚本开头添加
const backupFile = `comments.db.backup-${new Date().toISOString().slice(0,10)}`;
fs.copyFileSync('comments.db', backupFile);
console.log(`数据库已备份: ${backupFile}`);
```

#### 定期备份（推荐）

```bash
# 创建定时备份脚本
cat > /root/backup-db.sh << 'EOF'
#!/bin/bash
cd '/root/Intelligent Comment System'
BACKUP_DIR="/root/db-backups"
mkdir -p $BACKUP_DIR
cp comments.db "$BACKUP_DIR/comments.db.$(date +%Y%m%d-%H%M%S)"
# 只保留最近 7 天的备份
find $BACKUP_DIR -name "comments.db.*" -mtime +7 -delete
EOF

chmod +x /root/backup-db.sh

# 添加到 crontab（每天凌晨 2 点备份）
crontab -e
# 添加: 0 2 * * * /root/backup-db.sh
```

---

## 📊 配置变更检查清单

### 变更前（必须完成）

- [ ] 1. 在本地验证 `prompts.json` JSON 格式正确
- [ ] 2. 备份服务器当前数据库：`cp comments.db comments.db.backup-$(date +%Y%m%d)`
- [ ] 3. 记录当前服务状态：`systemctl status comment-api`
- [ ] 4. 准备回滚脚本（如果是首次变更）

### 变更中（按顺序执行）

- [ ] 1. 上传 `prompts.json` 到服务器
- [ ] 2. 执行 `node import_prompts.js` 导入配置
- [ ] 3. 验证导入成功（检查输出）
- [ ] 4. 测试 API 是否正常工作（curl 测试）
- [ ] 5. 如果测试失败，考虑重启服务

### 变更后（验证）

- [ ] 1. 执行冒烟测试（至少测试 3 种风格）
- [ ] 2. 检查最近 20 条日志：`journalctl -u comment-api -n 20`
- [ ] 3. 监控错误率 5 分钟
- [ ] 4. 更新配置变更记录

---

## 🚨 常见问题处理

### 问题 1：导入后 API 仍返回旧内容

**可能原因**：服务缓存了旧配置

**解决方案**：
```bash
# 方案 A：重启服务
systemctl restart comment-api

# 方案 B：使用热重载（如果已实现）
curl -X POST http://localhost:3001/internal/reload-prompts \
  -d '{"adminKey": "your-key"}'
```

### 问题 2：导入脚本执行失败

**可能原因**：
- JSON 格式错误
- 数据库被锁定
- 权限问题

**解决方案**：
```bash
# 检查 JSON 格式
node -e "console.log(JSON.parse(require('fs').readFileSync('public/prompts.json')))"

# 检查数据库状态
sqlite3 comments.db "PRAGMA integrity_check;"

# 检查文件权限
ls -la comments.db public/prompts.json
```

### 问题 3：服务重启失败

**可能原因**：
- 端口被占用
- Node.js 版本不匹配
- 配置文件错误

**解决方案**：
```bash
# 检查端口占用
netstat -tlnp | grep 3001

# 检查服务日志
journalctl -u comment-api -n 50 --no-pager

# 手动启动查看详细错误
cd '/root/Intelligent Comment System'
node server.js
```

---

## 📈 监控与告警

### 关键指标

1. **API 成功率**：> 99%
2. **平均响应时间**：< 3 秒
3. **错误率**：< 1%

### 监控脚本示例

```bash
#!/bin/bash
# api-health-check.sh

API_URL="http://8.134.89.239:3001/api/generate"

# 测试请求
RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$API_URL" \
  -H "Content-Type: application/json" \
  -d '{
    "code": "test123",
    "name": "健康检查",
    "gender": "男",
    "tags": "测试",
    "wordLimit": 100,
    "segment": "kindergarten",
    "style_key": "lively-horse"
  }')

HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
BODY=$(echo "$RESPONSE" | head -n-1)

if [ "$HTTP_CODE" == "200" ]; then
  echo "✅ API 健康检查通过"
  exit 0
else
  echo "❌ API 健康检查失败 (HTTP $HTTP_CODE)"
  echo "$BODY"
  exit 1
fi
```

---

## 📞 紧急联系流程

### 如果配置变更导致生产环境故障

1. **立即执行回滚**（见上文回滚流程）
2. **通知相关人员**
3. **记录故障详情**
4. **分析根因并改进流程**

---

## 📚 参考文档

- [提示词配置使用文档.md](./提示词配置使用文档.md)
- [部署指令.md](./部署指令.md)
- [用户使用手册.md](./用户使用手册.md)

---

**最后更新**：2026年01月21日
**维护人员**：智能评语系统运维团队
